     1                                  ; haribote-ipl
     2                                  ; TAB=4
     3                                  CYLS    EQU   10
     4                                  OS_BODY EQU   0xc200
     5                                  
     6                                  		ORG		0x7c00
     7                                  
     8 00000000 EB4E                    		JMP		entry
     9 00000002 90                      		DB		0x90
    10 00000003 48415249424F5445        		DB		"HARIBOTE"
    11 0000000B 0002                    		DW		512
    12 0000000D 01                      		DB		1
    13 0000000E 0100                    		DW		1
    14 00000010 02                      		DB		2
    15 00000011 E000                    		DW		224
    16 00000013 400B                    		DW		2880
    17 00000015 F0                      		DB		0xf0
    18 00000016 0900                    		DW		9
    19 00000018 1200                    		DW		18
    20 0000001A 0200                    		DW		2
    21 0000001C 00000000                		DD		0
    22 00000020 400B0000                		DD		2880
    23 00000024 000029                  		DB		0,0,0x29
    24 00000027 FFFFFFFF                		DD		0xffffffff
    25 0000002B 48415249424F54454F-     		DB		"HARIBOTEOS "
    25 00000034 5320               
    26 00000036 4641543132202020        		DB		"FAT12   "
    27 0000003E <res 00000012>          		RESB	18
    27          ******************       warning: uninitialized space declared in .text section: zeroing
    28                                  
    29                                  entry:
    30 00000050 B80000                  		MOV		AX,0
    31 00000053 8ED0                    		MOV		SS,AX
    32 00000055 BC007C                  		MOV		SP,0x7c00
    33 00000058 8ED8                    		MOV		DS,AX
    34                                  
    35 0000005A B82008                  		MOV		AX,0x0820 ; この辺シリンダとかの指定
    36 0000005D 8EC0                    		MOV		ES,AX
    37 0000005F B500                    		MOV		CH,0
    38 00000061 B600                    		MOV		DH,0
    39 00000063 B102                    		MOV		CL,2
    40                                  
    41                                  readloop:
    42 00000065 BE0000                  		MOV   SI,0
    43                                  
    44                                  retry:
    45                                  		; 失敗しても5回はドライブリセットを試す
    46 00000068 B402                    		MOV     AH, 0x02        ; INT 0x13での読み込み指定
    47 0000006A B001                    		MOV     AL, 1           ; 読み込む連続したセクタ数
    48 0000006C BB0000                  		MOV     BX, 0           ; Buffer Address | ES:BXのBX
    49 0000006F B200                    		MOV     DL, 0x00        ; ドライブ番号 Aドライブ
    50 00000071 CD13                    		INT     0x13            ; BIOS call -> エラーの時キャリーフラグが立つ
    51                                  														; [INT(0x13); ディスク関係 - (AT)BIOS - os-wiki](http://oswiki.osask.jp/?%28AT%29BIOS#q5006ed6)
    52 00000073 7310                    		JNC     next            ; Jump if Not CARRY FLAG == 1
    53                                  
    54 00000075 83C601                  		ADD     SI, 1
    55 00000078 83FE05                  		CMP     SI, 5
    56 0000007B 7335                    		JAE     error           ; if SI >= 5 then jump to error
    57                                  
    58 0000007D B400                    		MOV     AH, 0x00
    59 0000007F B200                    		MOV     DL, 0x00        ; ドライブを指定
    60 00000081 CD13                    		INT     0x13            ; ドライブをリセット
    61 00000083 EBE3                    		JMP     retry
    62                                  
    63                                  next:
    64 00000085 8CC0                    		MOV     AX,ES
    65 00000087 83C020                  		ADD			AX,0x0020
    66 0000008A 8EC0                    		MOV			ES,AX
    67 0000008C 80C101                  		ADD			CL,1 ; セクタに1足す
    68 0000008F 80F912                  		CMP			CL,18	; セクタの最大数が18だから、１８と比較する
    69 00000092 76D1                    		JBE			readloop ; jump if below
    70 00000094 B101                    		MOV			CL,1
    71 00000096 80C601                  		ADD			DH,1
    72 00000099 80FE02                  		CMP			DH,2
    73 0000009C 72C7                    		JB			readloop
    74 0000009E B600                    		MOV			DH,0
    75 000000A0 80C501                  		ADD			CH,1
    76 000000A3 80FD0A                  		CMP			CH,CYLS
    77 000000A6 72BD                    		JB			readloop
    78 000000A8 882EF00F                		MOV     [0x0ff0], CH
    79 000000AC E9(00C2)                		JMP     OS_BODY
    80                                  fin:
    81 000000AF F4                      		HLT
    82 000000B0 EBFD                    		JMP		fin
    83                                  
    84                                  error:
    85 000000B2 BE[C800]                		MOV		SI,msg
    86                                  putloop:
    87 000000B5 3E8A04                  		MOV   AL, BYTE [DS:SI]
    88 000000B8 83C601                  		ADD		SI,1
    89 000000BB 3C00                    		CMP		AL,0
    90 000000BD 74F0                    		JE		fin
    91 000000BF B40E                    		MOV		AH,0x0e
    92 000000C1 BB0F00                  		MOV		BX,15
    93 000000C4 CD10                    		INT		0x10
    94 000000C6 EBED                    		JMP		putloop
    95                                  msg:
    96 000000C8 0A0A                    		DB		0x0a, 0x0a
    97 000000CA 6C6F6164206572726F-     		DB		"load error"
    97 000000D3 72                 
    98 000000D4 0A                      		DB		0x0a
    99 000000D5 00                      		DB		0
   100                                  
   101 000000D6 <res 00000128>          		RESB  0x1fe-($-$$) ; $は先頭からどこまで進んでいるか
   101          ******************       warning: uninitialized space declared in .text section: zeroing
   102                                  											 ; $$はセクションの先頭
   103                                  											 ; よって($-$$)でセクションののどこまで進んでいるかを出せる
   104                                  
   105 000001FE 55AA                    		DB		0x55, 0xaa
